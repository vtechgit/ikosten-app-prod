<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBackToTrips()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      <span [ngSwitch]="currentStep">
        <span *ngSwitchCase="1">{{ 'titles.modules.process.step1.title' | translate }}</span>
        <span *ngSwitchCase="2">{{ 'titles.modules.process.step3.title' | translate }}</span>
        <span *ngSwitchCase="3">{{ 'titles.modules.process.analysis.results.title' | translate }}</span>
        <span *ngSwitchCase="4">{{ 'titles.modules.process.send-results.title' | translate }}</span>
        <span *ngSwitchCase="5">{{ 'titles.modules.process.send-results.result-sent' | translate }}</span>
        <span *ngSwitchDefault>{{ 'titles.modules.process.title' | translate }}</span>
      </span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="closeProcess()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>



<ion-content class="process-container">
  <div class="process-content" *ngIf="travelSelected">
    
    <!-- Header Section with Progress -->
    <div class="process-header">
      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
            <div class="step-number">
              <span *ngIf="currentStep <= 1">1</span>
              <ion-icon name="checkmark" *ngIf="currentStep > 1"></ion-icon>
            </div>
            <div class="step-title">{{ 'titles.modules.process.steps.receipts' | translate }}</div>
          </div>
          <div class="progress-line" [class.completed]="currentStep > 1"></div>
          <div class="progress-step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
            <div class="step-number">
              <span *ngIf="currentStep <= 2">2</span>
              <ion-icon name="checkmark" *ngIf="currentStep > 2"></ion-icon>
            </div>
            <div class="step-title">{{ 'titles.modules.process.steps.statement' | translate }}</div>
          </div>
          <div class="progress-line" [class.completed]="currentStep > 2"></div>
          <div class="progress-step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
            <div class="step-number">
              <span *ngIf="currentStep <= 3">3</span>
              <ion-icon name="checkmark" *ngIf="currentStep > 3"></ion-icon>
            </div>
            <div class="step-title">{{ 'titles.modules.process.steps.analysis' | translate }}</div>
          </div>
          <div class="progress-line" [class.completed]="currentStep > 3"></div>
          <div class="progress-step" [class.active]="currentStep >= 4" [class.completed]="currentStep > 4">
            <div class="step-number">
              <span *ngIf="currentStep <= 4">4</span>
              <ion-icon name="checkmark" *ngIf="currentStep > 4"></ion-icon>
            </div>
            <div class="step-title">{{ 'titles.modules.process.steps.export' | translate }}</div>
          </div>
        </div>
      </div>
      
      <!-- Travel Info Card -->
       <!--
            <div class="travel-info-card" @fadeIn>
        <div class="travel-info-content">
          <ion-icon name="airplane" class="travel-icon"></ion-icon>
          <div class="travel-details">
            <h2 class="travel-title">
              {{ convertKey(travelSelected.process_country?.country) | translate }}
              ({{ travelSelected.process_country?.code }})
            </h2>
            <p class="travel-subtitle" *ngIf="travelSelected.process_start_date">
              {{ travelSelected.process_start_date | date: 'dd/MM/yyyy' }}
              <span *ngIf="travelSelected.process_end_date"> - {{ travelSelected.process_end_date | date: 'dd/MM/yyyy' }}</span>
            </p>
          </div>
          <div class="travel-status">
            <ion-badge 
              [color]="travelSelected.process_status === 0 ? 'warning' : 
                       travelSelected.process_status === 1 ? 'primary' : 
                       travelSelected.process_status === 2 ? 'success' : 'medium'">
              <span *ngIf="travelSelected.process_status === 0">{{ 'status.pending' | translate }}</span>
              <span *ngIf="travelSelected.process_status === 1">{{ 'status.processing' | translate }}</span>
              <span *ngIf="travelSelected.process_status === 2">{{ 'status.completed' | translate }}</span>
              <span *ngIf="travelSelected.process_status > 2">{{ 'status.unknown' | translate }}</span>
            </ion-badge>
          </div>
        </div>
      </div>
      -->

    </div>
    
    <!-- Step 1: Upload Receipts -->
    <div *ngIf="currentStep === 1" class="step-container" @fadeIn>
      
      <!-- Country Selection -->
      <div class="process-card" *ngIf="isBillsArray() && getBillsArray().length > 0">
        <div class="card-header">
          <ion-icon name="flag" class="header-icon"></ion-icon>
          <div class="header-content">
            <h3 class="card-title">{{ 'titles.modules.process.countries.title' | translate }}</h3>
            <p class="card-subtitle">{{ 'titles.modules.process.countries.subtitle' | translate }}</p>
          </div>
        </div>
        <div class="card-content">
          <div class="country-badges">
            <ion-button 
              size="small" 
              (click)="selectCountry(iBill)" 
              [fill]="this.billPos == iBill ? 'solid':'outline'" 
              *ngFor="let bill of getBillsArray(); index as iBill"
              class="country-badge">
              {{convertKey(bill.country) | translate}}
            </ion-button>
            <ion-button 
              (click)="showModalPicker('inputs.select-country.title','add_country')" 
              fill="outline"
              shape="round" 
              class="add-country-btn">
              <ion-icon slot="icon-only" name="add"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>
      
      <!-- Receipts Upload Section -->
      <div class="process-card">
        <div class="card-header">
          <ion-icon name="receipt" class="header-icon"></ion-icon>
          <div class="header-content">
            <h3 class="card-title">
              {{ 'titles.modules.process.step1.content' | translate }}
              <ion-badge 
                color="primary" 
                *ngIf="currencyBlockSelected && currencyBlockSelected.country"
                class="country-badge-inline">
                {{ convertKey(currencyBlockSelected['country']) | translate}}
              </ion-badge>
            </h3>
          </div>
        </div>
        
        <div class="card-content">
          <!-- Receipt List -->
          <div class="receipt-list" *ngIf="!isUploadingOther && hasBillsAtCurrentPosition()">
            <div class="receipt-card" *ngFor="let billElement of getCurrentBillArray(); index as i" 
                 [class.success]="billElement.status == 1 && billElement.vendor"
                 [class.error]="billElement.status == 500 || (billElement.status == 1 && !billElement.vendor)"
                 [class.loading]="billElement.status == 0">
              
              <!-- Status Badge -->
              <div class="status-badge">
                <ion-icon 
                  name="checkmark-circle" 
                  color="success"
                  *ngIf="billElement.status == 1 && billElement.vendor && billElement.vendor != ''">
                </ion-icon>
                <ion-icon 
                  name="warning" 
                  color="warning"
                  *ngIf="billElement.status == 1 && (!billElement.vendor || billElement.vendor == '')">
                </ion-icon>
                <ion-icon 
                  name="close-circle" 
                  color="danger" 
                  *ngIf="billElement.status == 500">
                </ion-icon>
                <ion-spinner 
                  name="crescent" 
                  color="primary" 
                  *ngIf="billElement.status == 0">
                </ion-spinner>
              </div>

              <!-- Document Icon -->
              <div class="document-icon">
                <ion-icon 
                  name="document-text"
                  [color]="billElement.status == 1 && billElement.vendor ? 'primary' : 
                           billElement.status == 1 ? 'warning' :
                           billElement.status == 500 ? 'danger' : 'medium'">
                </ion-icon>
              </div>

              <!-- Receipt Content -->
              <div class="receipt-content">
                
                <!-- Title Section -->
                <div class="receipt-header">
                  <h3 class="receipt-vendor" *ngIf="billElement.status == 1 && billElement.vendor && billElement.vendor != ''">
                    {{billElement.vendor}}
                  </h3>
                  <h3 class="receipt-vendor error" *ngIf="billElement.status == 1 && (!billElement.vendor || billElement.vendor == '')">
                    {{ 'errors.file-uploads.cannot-read-vendor' | translate }}
                  </h3>
                  <h3 class="receipt-vendor filename" *ngIf="billElement.status == 500">
                    {{billElement.original_name}}
                  </h3>
                  <h3 class="receipt-vendor loading" *ngIf="billElement.status == 0">
                    {{ 'loadings.analysing' | translate }}...
                  </h3>
                </div>
                
                <!-- Details Section -->
                <div class="receipt-details" *ngIf="billElement.status == 1">
                  <div class="detail-item">
                    <ion-icon name="calendar-outline" class="detail-icon"></ion-icon>
                    <span class="detail-text">{{billElement.date | date: 'dd/MM/yyyy'}}</span>
                    <span class="detail-time" *ngIf="billElement.hour">{{billElement.hour}}</span>
                  </div>
                  <div class="detail-item amount">
                    <ion-icon name="cash-outline" class="detail-icon"></ion-icon>
                    <span class="detail-amount">${{billElement.total | number}}</span>
                    <span class="detail-currency">{{getCurrentBillCurrency()}}</span>
                  </div>
                </div>
                
                <!-- Error Message -->
                <div class="receipt-error-message" *ngIf="billElement.status == 500">
                  <ion-icon name="warning-outline" class="error-icon"></ion-icon>
                  <span>{{ 'errors.file-uploads.try-again' | translate }}</span>
                </div>
                
                <!-- Loading Progress -->
                <div class="receipt-progress" *ngIf="billElement.status == 0">
                  <ion-progress-bar type="indeterminate" color="primary"></ion-progress-bar>
                  <span class="progress-text">{{ 'loadings.processing' | translate }}...</span>
                </div>
              </div>

              <!-- Action Button -->
              <div class="receipt-actions">
                <ion-button 
                  fill="clear" 
                  color="danger" 
                  size="small"
                  (click)="deleteBill(billPos,i, billElement.document_id)"
                  class="delete-button">
                  <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Upload Section -->
          <div class="upload-section" *ngIf="isUploadingOther">
            
            <!-- Camera Upload (Mobile Only) -->
            <div class="upload-option mobile-only" *ngIf="(!imagesToUpload || imagesToUpload.length == 0) && !isUploading">
              <h4 class="upload-title">{{ 'titles.modules.process.step2.file-input.take-picture' | translate }}</h4>
              <div class="upload-area camera-upload" (click)="takePhoto()">
                <ion-icon name="camera" class="upload-icon"></ion-icon>
                <p class="upload-text">{{ 'titles.modules.process.step2.file-input.take-picture-note' | translate }}</p>
              </div>
            </div>

            <!-- File Upload -->
            <div class="upload-option" *ngIf="(!imagesToUpload || imagesToUpload.length == 0) && !isUploading">
              <h4 class="upload-title">{{ 'titles.modules.process.step2.file-input.upload-file' | translate }}</h4>
              <div class="upload-area file-upload" appDropFilesInput (fileDropped)="onFileDropped($event,'bills')">
                <input 
                  type="file" 
                  accept="image/jpeg,image/png,application/pdf" 
                  multiple="true" 
                  [disabled]="isUploading" 
                  #fileDrop 
                  id="fileDrop" 
                  (change)="fileBrowseHandler($event,'bills')">
                <ion-icon name="cloud-upload" class="upload-icon"></ion-icon>
                <p class="upload-text">{{ 'titles.modules.process.step2.file-input.upload-file-note' | translate }}</p>
              </div>
            </div>
            
            <!-- Progress Bar (shown when uploading) -->
            <ion-progress-bar type="indeterminate" *ngIf="isUploading" class="upload-progress"></ion-progress-bar>
            
            <!-- Image Preview Grid -->
            <div class="image-grid" *ngIf="imagesToUpload && imagesToUpload.length > 0">
              <div class="image-item" *ngFor="let image of imagesToUpload; index as i">
                <ion-button 
                  fill="clear" 
                  color="danger" 
                  class="delete-image-btn" 
                  (click)="deleteImageToUpload(i)">
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
                <ion-img [src]="image.dataUrl" class="preview-image"></ion-img>
              </div>
              <div class="image-item add-more" (click)="takePhoto()">
                <ion-icon name="add" class="add-icon"></ion-icon>
                <span>{{ 'buttons.add-more' | translate }}</span>
              </div>
            </div>
            
            <!-- Cancel Upload Button -->
            <ion-button 
              *ngIf="hasBillsAtCurrentPosition()" 
              fill="outline" 
              color="medium" 
              expand="block" 
              (click)="isUploadingOther=false"
              class="cancel-upload-btn">
              {{ 'buttons.cancel' | translate }}
              <ion-icon name="close-circle-outline" slot="end"></ion-icon>
            </ion-button>
          </div>
          
          <!-- Action Buttons -->
          <div class="action-buttons" *ngIf="!isUploadingOther">
            <ion-button 
              fill="solid"
              color="primary" 
              [disabled]="checkBillsErrors()" 
              (click)="openUploading()" 
              *ngIf="hasBillsAtCurrentPosition()">
              <ion-icon name="add" slot="start"></ion-icon>
              {{ 'buttons.add-receipt' | translate }}
            </ion-button>
            
            <ion-button 
              fill="outline"
              color="danger" 
              (click)="deleteAllReceiptsAlert()" 
              *ngIf="isBillsArray() && getBillsArray().length > 0">
              <ion-icon name="trash" slot="start"></ion-icon>
              {{ 'buttons.delete-country' | translate }}
            </ion-button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Bank Statement -->
    <div *ngIf="currentStep === 2" class="step-container" @fadeIn>
      
      <!-- Statement Configuration -->
      <div class="process-card">
        <div class="card-header">
          <ion-icon name="card" class="header-icon"></ion-icon>
          <div class="header-content">
            <h3 class="card-title">{{ 'titles.modules.process.step3.title' | translate }}</h3>
          </div>
        </div>
        
        <div class="card-content">
          <div class="config-section">
            <!-- Extract Type Selection -->
            <div class="config-item">
              <label class="config-label">{{ 'inputs.extract-type.label' | translate }}</label>
              <ion-select 
                interface="popover" 
                (ionChange)="changeExtractType()" 
                [(ngModel)]="extracts['extract']['type']"
                class="config-select">
                <ion-select-option value="credit">
                  {{ 'inputs.extract-type.options.credit-card' | translate }}
                </ion-select-option>
                <ion-select-option value="debit">
                  {{ 'inputs.extract-type.options.debit-card' | translate }}
                </ion-select-option>
              </ion-select>
            </div>
            
            <!-- Currency Selection -->
            <div class="config-item" (click)="showModalPicker('inputs.select-currency.title','currency')">
              <label class="config-label">{{ 'global.words.currency' | translate }}</label>
              <div class="config-selector">
                <span class="selector-value" *ngIf="extracts['extract']['currency'] != ''">
                  {{extracts['extract']['currency']}}
                </span>
                <span class="selector-placeholder" *ngIf="extracts['extract']['currency'] == ''">
                  {{ 'inputs.select-currency.title' | translate }}
                </span>
                <ion-icon name="chevron-forward" class="selector-chevron"></ion-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="process-card" *ngIf="extracts['extract']['type'] != '' && extracts['extract']['currency'] != ''">
        <div class="card-header">
          <ion-icon name="document-attach" class="header-icon"></ion-icon>
          <div class="header-content">
            <h3 class="card-title">{{ 'titles.modules.process.step4.title' | translate }}</h3>
          </div>
        </div>
        
        <div class="card-content">
          <!-- Upload Area -->
          <div class="upload-section" *ngIf="!this.extracts['extract']['file'] || this.extracts['extract']['file'] == ''">
            <div class="upload-area file-upload" appDropFilesInput (fileDropped)="onFileDropped($event,'extracts')">
              <input 
                type="file" 
                accept="image/jpeg,image/png,application/pdf" 
                [disabled]="isUploading" 
                #fileDrop 
                id="fileDrop" 
                (change)="fileBrowseHandler($event,'extracts')">
              <ion-icon name="cloud-upload" class="upload-icon"></ion-icon>
              <p class="upload-text">{{ 'titles.modules.process.step4.file-input.upload-file-note' | translate }}</p>
            </div>
          </div>

          <!-- Uploaded File Display -->
          <div class="receipt-list" *ngIf="this.extracts['extract']['file'] && this.extracts['extract']['file'] !=''">
            <div class="receipt-card"
                 [class.success]="this.extracts['extract']['status'] == 1 && this.extracts['extract']['bankName'] && this.extracts['extract']['bankName'] != 'undefined'"
                 [class.error]="this.extracts['extract']['status'] == 500 || (this.extracts['extract']['status'] == 1 && (!this.extracts['extract']['bankName'] || this.extracts['extract']['bankName'] == 'undefined'))"
                 [class.loading]="this.extracts['extract']['status'] == 0">
              
              <!-- Status Badge -->
              <div class="status-badge">
                <ion-icon 
                  name="checkmark-circle" 
                  color="success"
                  *ngIf="this.extracts['extract']['status'] == 1 && this.extracts['extract']['bankName'] && this.extracts['extract']['bankName'] != 'undefined'">
                </ion-icon>
                <ion-icon 
                  name="warning" 
                  color="warning"
                  *ngIf="this.extracts['extract']['status'] == 1 && (!this.extracts['extract']['bankName'] || this.extracts['extract']['bankName'] == 'undefined')">
                </ion-icon>
                <ion-icon 
                  name="close-circle" 
                  color="danger" 
                  *ngIf="this.extracts['extract']['status'] == 500">
                </ion-icon>
                <ion-spinner 
                  name="crescent" 
                  color="primary" 
                  *ngIf="this.extracts['extract']['status'] == 0">
                </ion-spinner>
              </div>

              <!-- Document Icon -->
              <div class="document-icon">
                <ion-icon 
                  name="document-text"
                  [color]="this.extracts['extract']['status'] == 1 && this.extracts['extract']['bankName'] && this.extracts['extract']['bankName'] != 'undefined' ? 'primary' : 
                           this.extracts['extract']['status'] == 1 ? 'warning' :
                           this.extracts['extract']['status'] == 500 ? 'danger' : 'medium'">
                </ion-icon>
              </div>

              <!-- Extract Content -->
              <div class="receipt-content">
                
                <!-- Title Section -->
                <div class="receipt-header">
                  <h3 class="receipt-vendor" *ngIf="this.extracts['extract']['status'] == 1 && this.extracts['extract']['bankName'] && this.extracts['extract']['bankName'] != 'undefined'">
                    {{this.extracts['extract']['bankName']}}
                  </h3>
                  <h3 class="receipt-vendor error" *ngIf="this.extracts['extract']['status'] == 1 && (!this.extracts['extract']['bankName'] || this.extracts['extract']['bankName'] == 'undefined')">
                    {{ 'errors.file-uploads.cannot-read-bank-name' | translate }}
                  </h3>
                  <h3 class="receipt-vendor filename" *ngIf="this.extracts['extract']['status'] == 500">
                    {{ 'errors.file-uploads.cannot-read-file' | translate }}
                  </h3>
                  <h3 class="receipt-vendor loading" *ngIf="this.extracts['extract']['status'] == 0">
                    {{this.extracts['extract']['original_name']}}
                  </h3>
                </div>
                
                <!-- Details Section -->
                <div class="receipt-details" *ngIf="this.extracts['extract']['status'] == 1 && this.extracts['extract']['startDate'] && this.extracts['extract']['endDate']">
                  <div class="detail-item">
                    <ion-icon name="calendar-outline" class="detail-icon"></ion-icon>
                    <span class="detail-text">{{this.extracts['extract']['startDate'] | date: 'dd/MM/yyyy'}} - {{this.extracts['extract']['endDate'] | date: 'dd/MM/yyyy'}}</span>
                  </div>
                  <div class="detail-item">
                    <ion-icon name="card-outline" class="detail-icon"></ion-icon>
                    <span class="detail-text">{{extracts['extract']['type'] === 'credit' ? ('inputs.extract-type.options.credit-card' | translate) : ('inputs.extract-type.options.debit-card' | translate)}}</span>
                  </div>
                </div>
                
                <!-- Error Message -->
                <div class="receipt-error-message" *ngIf="this.extracts['extract']['status'] == 500">
                  <ion-icon name="warning-outline" class="error-icon"></ion-icon>
                  <span>{{ 'errors.file-uploads.try-again' | translate }}</span>
                </div>
                
                <!-- Loading Progress -->
                <div class="receipt-progress" *ngIf="this.extracts['extract']['status'] == 0">
                  <ion-progress-bar type="indeterminate" color="primary"></ion-progress-bar>
                  <span class="progress-text">{{ 'loadings.processing' | translate }}...</span>
                </div>
              </div>

              <!-- Action Button -->
              <div class="receipt-actions">
                <ion-button 
                  fill="clear" 
                  color="danger" 
                  size="small"
                  (click)="deleteExtract(0, this.extracts['extract']['document_id'])"
                  class="delete-button">
                  <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Analysis Results -->
    <div *ngIf="currentStep === 3" class="step-container" @fadeIn>
      
      <!-- Loading State -->
      <div class="process-card loading-state" *ngIf="!results && !isLoadingAnalysisFromCache">
        <div class="card-content">
          <div class="loading-content">
            <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
            <h3 class="loading-title">{{ 'titles.modules.process.analysis.loading.title' | translate }}</h3>
            <p class="loading-subtitle">{{ 'titles.modules.process.analysis.loading.subtitle' | translate }}...</p>
            <ion-progress-bar type="indeterminate" class="loading-progress"></ion-progress-bar>
          </div>
        </div>
      </div>
      
      <!-- Results State -->
      <div *ngIf="results">
        <!-- Analysis Overview -->
        <div class="process-card">
          <div class="card-header">
            <ion-icon name="analytics" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.analysis.results.title' | translate }}</h3>
              <p class="card-subtitle">{{ 'titles.modules.process.analysis.subtitle' | translate }}</p>
            </div>
          </div>
        </div>

        <!-- Not Matched Items -->
        <div class="process-card error-card" *ngIf="results && results.notMatched && results.notMatched.length > 0">
          <div class="card-header error-header">
            <ion-icon name="warning" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">
                {{ 'global.words.check' | translate }} {{countNotMatched()}} 
                {{ countNotMatched() == 1 ? ('titles.modules.process.analysis.results.not-matched-title-singular' | translate) : ('titles.modules.process.analysis.results.not-matched-title-plural' | translate)}} 
                {{ 'titles.modules.process.analysis.results.not-matched-complement' | translate }}
              </h3>
            </div>
            <ion-button 
              fill="clear" 
              color="light" 
              (click)="deleteAllNotMatched()"
              class="header-action">
              <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
          
          <div class="card-content">
            <div class="not-matched-container">
              <div class="country-group" *ngFor="let group of results.notMatched; index as igroup">
                <div class="country-header" *ngIf="group.bill && group.bill.length > 0">
                  <h4 class="country-title">{{convertKey(group.country) | translate}}</h4>
                </div>
                
                <div class="receipt-error-item" *ngFor="let line of group.bill; index as iextract">
                  <div class="error-content">
                    <div class="error-header">
                      <div class="error-icon">
                        <ion-icon name="alert-circle" color="danger"></ion-icon>
                      </div>
                      <div class="error-info">
                        <h4 class="error-title" *ngIf="line.reason && line.reason == 'vendor'">
                          {{ 'errors.analysis.vendor-does-not-match' | translate }}
                        </h4>
                        <h3 class="vendor-name">{{line.vendor}}</h3>
                      </div>
                    </div>
                    
                    <div class="error-details">
                      <div class="detail-row">
                        <span class="detail-label">{{ 'global.words.date' | translate }}:</span>
                        <span class="detail-value" [ngClass]="!line.date || line.date == '' ? 'error-value' : ''">
                          {{line.date | date:'dd/MM/yyyy'}}
                          <span *ngIf="!line.date || line.date == ''" class="error-text">
                            ({{ 'errors.analysis.reading-error' | translate }})
                          </span>
                          <span *ngIf="line.reason && line.reason == 'date'" class="error-text">
                            ({{ 'errors.analysis.does-not-match' | translate }})
                          </span>
                        </span>
                      </div>
                      
                      <div class="detail-row">
                        <span class="detail-label">{{ 'errors.analysis.receipt-does-not-match' | translate }}:</span>
                        <div class="amount-details">
                          <span class="amount-value">${{line.bill | number}} {{line.currencyBill}}</span>
                          <span *ngIf="line.reason && line.reason == 'value'" class="error-text">
                            ({{ 'errors.analysis.does-not-match' | translate }})
                          </span>
                          <div *ngIf="line.exchange" class="exchange-info">
                            <span class="exchange-label">{{ 'titles.modules.process.analysis.results.money-exchange' | translate }}</span>
                            <span class="exchange-value">${{line.exchangeValue | number}} {{line.currency}}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="extract-status">
                      <ion-icon name="close-circle" color="danger" class="status-icon"></ion-icon>
                      <span class="status-text">{{ 'errors.analysis.extract-does-not-match' | translate }}</span>
                    </div>
                  </div>
                  
                  <div class="error-actions">
                    <ion-button 
                      fill="clear" 
                      color="danger" 
                      size="small"
                      (click)="deleteNotMatched(igroup,iextract, line)">
                      <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                    
                    <ion-button 
                      fill="clear" 
                      color="medium" 
                      size="small"
                      (click)="modalHelp=true">
                      <ion-icon name="help-circle-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Not Matched Extract Lines -->
        <div class="process-card info-card" *ngIf="results && results.notMatchedExtractLines && results.notMatchedExtractLines.lines && results.notMatchedExtractLines.lines.length > 0">
          <div class="card-header info-header">
            <ion-icon name="document-text" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.analysis.results.extract-lines-title' | translate }}</h3>
              <p class="card-subtitle">{{ 'titles.modules.process.analysis.results.extract-lines-subtitle' | translate }}</p>
            </div>
          </div>
          
          <div class="card-content">
            <div class="extract-info-row">
              <div class="info-item">
                <span class="info-label">{{ 'global.words.bank' | translate }}:</span>
                <span class="info-value">{{results.notMatchedExtractLines.bankName || 'N/A'}}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'global.words.currency' | translate }}:</span>
                <span class="info-value">{{results.notMatchedExtractLines.currency}}</span>
              </div>
              <div class="info-item">
                <span class="info-label">{{ 'global.words.type' | translate }}:</span>
                <span class="info-value">{{results.notMatchedExtractLines.type}}</span>
              </div>
            </div>
            
            <div class="extract-lines-container">
              <div class="extract-line-item" *ngFor="let line of results.notMatchedExtractLines.lines">
                <div class="line-content">
                  <div class="line-header">
                    <div class="line-icon">
                      <ion-icon name="document-outline" color="medium"></ion-icon>
                    </div>
                    <div class="line-info">
                      <h4 class="line-description">{{line.description || 'Sin descripci√≥n'}}</h4>
                      <div class="line-meta">
                        <span class="line-date" *ngIf="line.date">
                          <ion-icon name="calendar-outline" size="small"></ion-icon>
                          {{line.date | date:'dd/MM/yyyy'}}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="line-amount">
                    <span class="amount-value">{{line.amount | number:'1.2-2'}} {{results.notMatchedExtractLines.currency}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Success State (when everything is matched) -->
        <div class="process-card success-card" *ngIf="results && (!results.notMatched || results.notMatched.length === 0) && (!results.notMatchedExtractLines || !results.notMatchedExtractLines.lines || results.notMatchedExtractLines.lines.length === 0)">
          <div class="card-header success-header">
            <ion-icon name="checkmark-circle" class="header-icon" color="success"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.analysis.results.all-matched-title' | translate }}</h3>
              <p class="card-subtitle">{{ 'titles.modules.process.analysis.results.all-matched-subtitle' | translate }}</p>
            </div>
          </div>
          
          <div class="card-content text-center">
            <p class="success-message">{{ 'titles.modules.process.analysis.results.all-matched-message' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Send Results -->
    <div *ngIf="currentStep === 4" class="step-container" @fadeIn>
      
      <!-- Not Sending State -->
      <div *ngIf="!sendingForm">
        <!-- Logged in User -->
        <div>
          <!-- Header Card -->
          <div class="process-card">
            <div class="card-header">
              <ion-icon name="send" class="header-icon"></ion-icon>
              <div class="header-content">
                <h3 class="card-title">{{ 'titles.modules.process.send-results.title' | translate }}</h3>
                <p class="card-subtitle">{{ 'titles.modules.process.send-results.subtitle' | translate }}</p>
              </div>
            </div>
          </div>

          <!-- User Information -->
          <div class="process-card">
            <div class="card-header">
              <ion-icon name="person" class="header-icon"></ion-icon>
              <div class="header-content">
                <h3 class="card-title">{{ 'titles.modules.process.user-info.title' | translate }}</h3>
                <p class="card-subtitle">{{ 'titles.modules.process.user-info.subtitle' | translate }}</p>
              </div>
            </div>
            
            <div class="card-content">
              <div class="form-section">
                <div class="input-group">
                  <label class="input-label">{{ 'inputs.user-name.title' | translate }}</label>
                  <ion-input 
                    placeholder="{{ 'inputs.user-name.place-holder' | translate }}" 
                    (ionChange)="changeExportSettings()" 
                    [(ngModel)]="userName"
                    class="modern-input">
                  </ion-input>
                </div>
                
                <div class="input-group">
                  <label class="input-label">{{ 'inputs.user-email.title' | translate }}</label>
                  <ion-input 
                    placeholder="{{ 'inputs.user-email.placeholder' | translate }}" 
                    (ionChange)="changeExportSettings()" 
                    [(ngModel)]="userEmail"
                    class="modern-input">
                  </ion-input>
                </div>
              </div>
            </div>
          </div>

          <!-- Export Options -->
          <div class="process-card">
            <div class="card-header">
              <ion-icon name="download" class="header-icon"></ion-icon>
              <div class="header-content">
                <h3 class="card-title">{{ 'inputs.export-format.title' | translate }}</h3>
                <p class="card-subtitle">{{ 'inputs.export-format.subtitle' | translate }}</p>
              </div>
            </div>
            
            <div class="card-content">
              <div class="options-section">
                <div class="option-item" (click)="sendPdf = !sendPdf; changeExportSettings()">
                  <div class="option-content">
                    <div class="option-icon">
                      <ion-icon name="document-text" color="danger"></ion-icon>
                    </div>
                    <div class="option-info">
                      <h4 class="option-title">{{ 'inputs.export-format.send-pdf' | translate }}</h4>
                      <p class="option-description">{{ 'inputs.export-format.pdf-description' | translate }}</p>
                    </div>
                  </div>
                  <ion-checkbox [(ngModel)]="sendPdf" (ionChange)="changeExportSettings()"></ion-checkbox>
                </div>
                
                <div class="option-item" (click)="sendExcel = !sendExcel; changeExportSettings()">
                  <div class="option-content">
                    <div class="option-icon">
                      <ion-icon name="grid" color="success"></ion-icon>
                    </div>
                    <div class="option-info">
                      <h4 class="option-title">{{ 'inputs.export-format.send-excel' | translate }}</h4>
                      <p class="option-description">{{ 'inputs.export-format.excel-description' | translate }}</p>
                    </div>
                  </div>
                  <ion-checkbox [(ngModel)]="sendExcel" (ionChange)="changeExportSettings()"></ion-checkbox>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      
      <!-- Sending State -->
      <div *ngIf="sendingForm">
        <div class="process-card loading-state">
          <div class="card-content">
            <div class="loading-content">
              <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
              <h3 class="loading-title">{{ 'loadings.sending-results' | translate }}...</h3>
              <p class="loading-subtitle">{{ 'loadings.sending-subtitle' | translate }}</p>
              <ion-progress-bar type="indeterminate" class="loading-progress"></ion-progress-bar>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5: Final Results -->
    <div *ngIf="currentStep === 5" class="step-container" @fadeIn>
      
      <!-- Success State -->
      <div *ngIf="this.travelSelected['process_status'] != 2">
        <!-- Success Header -->
        <div class="process-card success-card">
          <div class="card-content">
            <div class="success-content">
              <div class="success-icon">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
              </div>
              <h2 class="success-title">{{ 'titles.modules.process.send-results.result-sent' | translate }}</h2>
              <p class="success-subtitle">{{ 'titles.modules.process.send-results.success-message' | translate }}</p>
            </div>
          </div>
        </div>

        <!-- Important Reminder -->
        <div class="process-card info-card">
          <div class="card-header">
            <ion-icon name="information-circle" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.send-results.reminder-title' | translate }}</h3>
            </div>
          </div>
          <div class="card-content">
            <p class="info-text">{{ 'titles.modules.process.send-results.error-reminder' | translate }}</p>
          </div>
        </div>
        
        <!-- Rating Section -->
        <div class="process-card rating-card">
          <div class="card-header">
            <ion-icon name="star" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.send-results.rating-invite' | translate }} Ikosten?</h3>
              <p class="card-subtitle">{{ 'titles.modules.process.send-results.rating-subtitle' | translate }}</p>
            </div>
          </div>
          <div class="card-content">
            <app-star-rating (sent)="finishProcess($event)"></app-star-rating>
          </div>
        </div>
      </div>
      
      <!-- Resend State -->
      <div *ngIf="this.travelSelected['process_status'] == 2">
        <div class="process-card warning-card">
          <div class="card-header">
            <ion-icon name="refresh" class="header-icon"></ion-icon>
            <div class="header-content">
              <h3 class="card-title">{{ 'titles.modules.process.send-results.resend-title' | translate }}</h3>
              <p class="card-subtitle">{{ 'titles.modules.process.send-results.resend-subtitle' | translate }}</p>
            </div>
          </div>
          
          <div class="card-content">
            <div class="resend-section">
              <ion-button 
                expand="block" 
                color="primary"
                [disabled]="sendingForm" 
                (click)="reSendResult()"
                class="resend-button">
                <ion-spinner *ngIf="sendingForm" name="crescent" slot="start"></ion-spinner>
                <ion-icon *ngIf="!sendingForm" name="send-outline" slot="start"></ion-icon>
                {{ 'buttons.send' | translate }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Modales -->
  <ion-modal [isOpen]="openModalMemberships" (willDismiss)="onWillDismiss()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="onWillDismiss()">{{ 'buttons.cancel' | translate }}</ion-button>
          </ion-buttons>
          <ion-title>{{ 'titles.membership.choose-plan' | translate }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-sm="6">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>{{ 'membership.basic.price' | translate }}</ion-card-title>
                  <ion-card-subtitle>{{ 'membership.basic.title' | translate }}</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-list>
                    <ion-item lines="none">{{ 'membership.basic.feature1' | translate }}</ion-item>
                    <ion-item lines="none">{{ 'membership.basic.feature2' | translate }}</ion-item>
                    <ion-item lines="none">{{ 'membership.basic.feature3' | translate }}</ion-item>
                    <ion-item lines="none">{{ 'membership.basic.feature4' | translate }}</ion-item>
                  </ion-list>
                </ion-card-content>
                <div class="ion-padding">
                  <ion-button expand="block">{{ 'buttons.choose' | translate }}</ion-button>
                </div>
              </ion-card>
            </ion-col>
            <ion-col size="12" size-sm="6">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>{{ 'membership.pro.price' | translate }}</ion-card-title>
                  <ion-card-subtitle>{{ 'membership.pro.title' | translate }}</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                  <ion-list>
                    <ion-item lines="none">{{ 'membership.pro.feature1' | translate }}</ion-item>
                    <ion-item lines="none">{{ 'membership.pro.feature2' | translate }}</ion-item>
                    <ion-item lines="none">{{ 'membership.pro.feature3' | translate }}</ion-item>
                  </ion-list>
                </ion-card-content>
                <div class="ion-padding">
                  <ion-button expand="block">{{ 'buttons.choose' | translate }}</ion-button>
                </div>
              </ion-card>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="isEdditingLine" (willDismiss)="onWillDismissEditLine()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button color="danger" (click)="isEdditingLine=false">{{ 'buttons.cancel' | translate }}</ion-button>
          </ion-buttons>
          <ion-title>{{ 'titles.modules.process.edit-receipts.title' | translate }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list [inset]="true">
          <ion-list-header>
            {{ 'titles.modules.process.edit-receipts.section-edit-receipt-title' | translate }}
          </ion-list-header>
          <ion-img class="viewer-image" *ngIf="editLineReceipt && isImage(editLineReceipt.type)" [src]="sanitizeImage(editLineReceipt.blob)"></ion-img>

          <ion-item (click)="toggleDate = !toggleDate; toggleTime=false;">
            <ion-label>{{ 'global.words.date' | translate }}: <span *ngIf="editLineReason == 'date'" class="color-danger">{{ 'errors.analysis.does-not-match' | translate }}</span></ion-label>
            <ion-chip class="chip-date">
              {{editLineDate | date: 'dd/MM/yyyy'}}
              <ion-ripple-effect></ion-ripple-effect>
            </ion-chip>
          </ion-item>
          <p class="color-danger ion-padding-start" style="margin-top: 5px; margin-left: 0px; margin-bottom: 0px;" *ngIf="editLineReason == 'date'"><ion-icon name="alert-circle-outline"></ion-icon>{{ 'errors.analysis.date-does-not-match' | translate }}</p>

          <ion-item *ngIf="toggleDate">
            <ion-datetime style="width: 100%; margin: auto;" id="dateLine" [locale]="dateLocale" [(ngModel)]="editLineDate" presentation="date"></ion-datetime>
          </ion-item>

          <ion-item (click)="toggleTime = !toggleTime; toggleDate=false;">
            <ion-label>{{ 'global.words.hour' | translate }}:</ion-label>
            <ion-chip class="chip-date">
              {{editLineTime | date: 'hh:mm aa'}}
              <ion-ripple-effect></ion-ripple-effect>
            </ion-chip>
          </ion-item>
          <ion-item *ngIf="toggleTime">
            <ion-datetime style="width: 100%; margin: auto;" [locale]="dateLocale" [(ngModel)]="editLineTime" id="hourLine" presentation="time"></ion-datetime>
          </ion-item>

          <ion-item>
            <ion-input label="{{ 'inputs.edit-line-vendor.title' | translate }}" labelPlacement="floating" placeholder="{{ 'inputs.edit-line-vendor.placeholder' | translate }}" [(ngModel)]="editLineDescription"></ion-input>
          </ion-item>
          <p class="color-danger ion-padding-start" style="margin-top: 5px; margin-left: 0px; margin-bottom: 0px;" *ngIf="editLineReason == 'vendor'"><ion-icon name="alert-circle-outline"></ion-icon>{{ 'errors.analysis.vendor-does-not-match' | translate }}</p>

          <ion-item>
            <ion-input label="{{ 'inputs.edit-line-bill-value.title' | translate }}" labelPlacement="floating" type="number" min="0" placeholder="{{ 'inputs.edit-line-bill-value.placeholder' | translate }}" [(ngModel)]="editLineBill"></ion-input>
          </ion-item>
          <p class="color-danger ion-padding-start" style="margin-top: 5px; margin-left: 0px; margin-bottom: 0px;" *ngIf="editLineReason == 'value'"><ion-icon name="alert-circle-outline"></ion-icon>{{ 'errors.analysis.value-does-not-match' | translate }}</p>

          <ion-item>
            <ion-select label="{{ 'inputs.bill-currency.title' | translate }}" placeholder="{{ 'inputs.bill-currency.placeholder' | translate }}" [(ngModel)]="editLineCurrency">
              <ion-select-option *ngFor="let currency of currencies" [value]="currency.code">{{convertKey(currency.country) | translate}} ({{currency.code}})</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-list>

        <div class="list-spacer"></div>
      </ion-content>
      <ion-footer class="d-flex flex-justify-space-between" style="padding: 5px;">
        <ion-button color="danger" class="button-controll" style="float:right" (click)="this.isEdditingLine=false">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          {{ 'buttons.close' | translate }}
        </ion-button>

        <ion-button [disabled]="this.editLineDescription =='' || !this.editLineBill || this.editLineBill <=0" color="primary" class="button-controll" style="float:right" (click)="finishEditLine()">
          {{ 'buttons.confirm' | translate }}
          <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </ion-footer>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="modalHelp" (willDismiss)="onWillDismissModalHelp()">
    <ng-template>
      <ion-header>
        <ion-toolbar class="spacer-toolbar" *ngIf="platform.is('ios') && !this.platform.is('mobileweb')"></ion-toolbar>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button color="danger" (click)="modalHelp=false">{{ 'buttons.close' | translate }}</ion-button>
          </ion-buttons>
          <ion-title>{{ 'global.words.help' | translate }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="ion-padding">
          <ion-img style="max-width: 50%;" src="../../../assets/images/Identificador[Fondo Blanco].png" alt="ikosten logo"></ion-img>
          <ion-list class="ion-margin-top">
            <ion-list-header>
              {{ 'titles.modules.process.help.title' | translate }}:
            </ion-list-header>
            <ul class="helpList">
              <li>{{ 'titles.modules.process.help.list-1' | translate }}</li>
              <li>{{ 'titles.modules.process.help.list-2' | translate }}</li>
              <li>{{ 'titles.modules.process.help.list-3' | translate }}</li>
              <li>{{ 'titles.modules.process.help.list-4' | translate }}</li>
              <li>{{ 'titles.modules.process.help.list-5' | translate }}</li>
            </ul>
            <ion-list-header>
              {{ 'titles.modules.process.help.complement' | translate }}
            </ion-list-header>

            <ion-grid>
              <ion-row>
                <ion-col size="6" class="d-flex flex-center">
                  <ion-button color="light" class="button-controll" (click)="modalHelp=false">
                    {{ 'buttons.close' | translate }}
                  </ion-button>
                </ion-col>
                <ion-col size="6" class="d-flex flex-center">
                  <ion-button color="primary" class="button-controll" (click)="skipRevision()">
                    {{ 'buttons.skip-revision' | translate }}
                    <ion-icon name="flash" slot="end"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openModalAddTravel" (willDismiss)="onWillDismissAddTravel()">
    <ng-template>
      <ion-header>
        <ion-toolbar class="spacer-toolbar" *ngIf="platform.is('ios') && !this.platform.is('mobileweb')"></ion-toolbar>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button (click)="onWillDismissAddTravel()" color="primary">{{ 'buttons.cancel' | translate }}</ion-button>
          </ion-buttons>
          <ion-title>{{ 'titles.modules.travels.create.title' | translate }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div>
          <ion-card>
            <ion-card-header>
              <ion-card-title>{{ 'titles.modules.travels.create.complement' | translate }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item button (click)="showModalPicker('inputs.select-country.title','country')">
                <ion-label *ngIf="currencyBlockSelected">{{ convertKey(currencyBlockSelected['country']) | translate}} ({{currencyBlockSelected['code']}})</ion-label>
                <ion-label *ngIf="!currencyBlockSelected">{{ 'inputs.select-country.title' | translate }}</ion-label>
              </ion-item>
            </ion-card-content>
          </ion-card>
          <ion-card>
            <ion-card-header>
              <ion-card-title>{{ 'titles.modules.travels.create.date-travel-complement' | translate }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item (click)="toggleDate = !toggleDate; toggleTime=false;scrollToTarget('dateLine');">
                <ion-label>{{ 'global.words.date' | translate }}:</ion-label>
                <ion-chip class="chip-date">
                  {{todayDate | date: 'dd/MM/yyyy'}}
                  <ion-ripple-effect></ion-ripple-effect>
                </ion-chip>
              </ion-item>
              <ion-item *ngIf="toggleDate">
                <ion-datetime style="width: 100%; margin: auto;" id="dateLine" [locale]="dateLocale" [(ngModel)]="todayDate" presentation="date"></ion-datetime>
              </ion-item>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-content>
      <ion-footer class="d-flex flex-center" style="padding: 10px 5px 20px 5px;">
        <ion-button [disabled]="!this.currencyBlockSelected || !todayDate" color="primary" class="button-controll" (click)="createProcess()">
          {{ 'buttons.create-travel' | translate }}
          <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </ion-footer>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="showAlertLogin" (willDismiss)="showAlertLogin=false;">
    <ng-template>
      <ion-header [translucent]="true">
        <ion-toolbar class="spacer-toolbar" *ngIf="platform.is('ios') && !this.platform.is('mobileweb')"></ion-toolbar>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-button color="light" (click)="showAlertLogin=false">{{ 'buttons.close' | translate }}</ion-button>
          </ion-buttons>
          <ion-title>{{ 'titles.modules.login-warning.title' | translate }}</ion-title>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="ion-padding">
          <ion-img style="max-width: 50%;" src="../../../assets/images/Identificador[Fondo Blanco].png" alt="ikosten logo"></ion-img>
          <ion-list class="ion-margin-top">
            <ion-list-header>
              {{ 'titles.modules.login-warning.title-complement' | translate }}
            </ion-list-header>
            <div class="ion-margin-start ion-margin-bottom">
              <p>{{ 'titles.modules.login-warning.content-1' | translate }}</p>
              <p>{{ 'titles.modules.login-warning.content-2' | translate }}</p>
            </div>
            <ion-button expand="block" color="primary" class="ion-margin-top" (click)="openLogin()">
              {{ 'buttons.sign-in' | translate }}
            </ion-button>
          </ion-list>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <app-country-picker (optionSelected)="pickerOptionSelected($event)" (dismiss)="pickerDismissed()" [selectedOption]="currencyBlockSelected" [isModalOpen]="showPicker" [modalTitle]="pickerTitle" [type]="pickerType" [options]="pickerOptions" [temp]="pickerOptions"></app-country-picker>

  <!-- Alertas -->
  <!-- delete bill -->
  <ion-alert
    [isOpen]="isAlertDeleteExtract"
    header="{{ 'alerts.delete-extract.title' | translate }}"
    subHeader="{{ 'alerts.delete-extract.subtitle' | translate }}"
    [buttons]="deleteExtractAlertButtons"
    (didDismiss)="dismissDeleteExtract()">
  </ion-alert>

  <!-- delete line -->
  <ion-alert 
    [isOpen]="isDeletingLine"
    header="{{ 'alerts.delete-line.title' | translate }}"
    subHeader="{{ 'alerts.delete-line.subtitle' | translate }}"
    [buttons]="deleteLineAlertButtons"
    (didDismiss)="dismissDeleteLine()">
  </ion-alert>

  <ion-alert 
    [isOpen]="isDeletingAllNotMatched"
    header="{{ 'alerts.delete-all-not-matched.title' | translate }}"
    subHeader="{{ 'alerts.delete-all-not-matched.subtitle' | translate }}"
    [buttons]="deleteAllNotMatchedAlertButtons"
    (didDismiss)="dismissDeleteAllNotMatched()">
  </ion-alert>

  <!-- founds alert -->
  <ion-alert 
    [isOpen]="showAlertFounds"
    header="{{ 'alerts.founds.title' | translate }} {{countNotMatched() + (countNotMatched() == 1 ? ('alerts.founds.complement-singular' | translate) : ('alerts.founds.complement-plural' | translate))}}"
    subHeader="{{ 'alerts.founds.subtitle' | translate }}"
    [buttons]="alertButtons"
    (didDismiss)="dismissAlertFounds()">
  </ion-alert>

  <!-- re send alert -->
  <ion-alert 
    [isOpen]="showAlertResend"
    header="{{ 'alerts.resend.title' | translate }}"
    subHeader="{{ 'alerts.resend.subtitle' | translate }}"
    [buttons]="alertButtons"
    (didDismiss)="showAlertResend = false;">
  </ion-alert>

  <!-- founds alert -->
  <ion-alert 
    [isOpen]="showAlertFoundsMatched"
    header="{{ 'alerts.no-matched-bills.title' | translate }}"
    subHeader="{{ 'alerts.no-matched-bills.subtitle' | translate }}"
    [buttons]="alertButtons"
    (didDismiss)="dismissAlertFoundsNotMatched()">
  </ion-alert>

  <!-- restart alert -->
  <ion-alert 
    [isOpen]="showAlertRestart"
    header="{{ 'alerts.restart-process.title' | translate }}"
    subHeader="{{ 'alerts.restart-process.subtitle' | translate }}"
    [buttons]="alertRestartButtons"
    (didDismiss)="dismissAlertRestart()">
  </ion-alert>

  <!-- time alert -->
  <ion-alert 
    [isOpen]="showAlertTime"
    header="{{ 'alerts.time-warning.title' | translate }}"
    subHeader="{{ 'alerts.time-warning.subtitle' | translate }}"
    [buttons]="['buttons.accept' | translate]"
    (didDismiss)="showAlertTime=false">
  </ion-alert>

  <!-- delete extract -->
  <ion-alert *ngIf="this.extracts"
    [isOpen]="isAlertDeleteBill"
    header="{{ 'alerts.delete-bill.title' | translate }}"
    subHeader="{{ 'alerts.delete-bill.subtitle' | translate }}"
    [buttons]="deleteBillAlertButtons"
    (didDismiss)="dismissDeleteBill()">
  </ion-alert>

  <!-- delete all -->
  <ion-alert
    [isOpen]="isAlertDeleteAll"
    header="{{ 'alerts.delete-all-bills.title' | translate }}"
    subHeader="{{ 'alerts.delete-all-bills.subtitle' | translate }}"
    [buttons]="deleteAllAlertButtons"
    (didDismiss)="dismissDeleteAll()">
  </ion-alert>

  <!-- Restart Analysis -->
  <ion-alert 
    [isOpen]="isAlertGoBack"
    header="{{ 'alerts.go-back-analysis.title' | translate }}"
    subHeader="{{ 'alerts.go-back-analysis.subtitle' | translate }}"
    [buttons]="goBackAlertButtons"
    (didDismiss)="isAlertGoBack=false">
  </ion-alert>

  <!-- Delete Travel Confirmation -->
  <ion-alert 
    [isOpen]="showAlertDeleteTravel"
    header="{{ 'alerts.delete-travel.title' | translate }}"
    subHeader="{{ 'alerts.delete-travel.subtitle' | translate }}"
    [buttons]="deleteTravelAlertButtons"
    (didDismiss)="showAlertDeleteTravel=false">
  </ion-alert>

</ion-content>
<!-- Navigation Footer -->
<ion-footer class="navigation-footer">
  <ion-toolbar>
    <div class="navigation-controls">
      
      <!-- Back Buttons - No mostrar si currentStep === 1 -->
      <ion-button 
        fill="outline" 
        color="medium" 
        class="nav-button back-button" 
        (click)="backStep()" 
        *ngIf="currentStep > 1 && (currentStep == 2 || currentStep == 4)">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        {{ 'buttons.back' | translate }}
      </ion-button>

      <ion-button 
        fill="outline" 
        color="medium" 
        class="nav-button back-button" 
        (click)="isAlertGoBack = true" 
        *ngIf="currentStep == 3">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        {{ 'buttons.back' | translate }}
      </ion-button>

      <!-- Next/Action Buttons -->
      <ion-button 
        [disabled]="!hasSuccessfulBills()" 
        color="primary" 
        class="nav-button next-button" 
        (click)="nextStep()" 
        *ngIf="currentStep == 1 && (!imagesToUpload || imagesToUpload.length == 0)">
        {{ 'buttons.next' | translate }}
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        [disabled]="!imagesToUpload || imagesToUpload.length == 0" 
        color="primary" 
        class="nav-button next-button" 
        (click)="uploadImagesBase64()" 
        *ngIf="currentStep == 1 && imagesToUpload && imagesToUpload.length > 0">
        {{ 'buttons.next' | translate }}
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        [disabled]="!this.extracts['extract']['status'] || this.extracts['extract']['status'] == 0 || this.extracts['extract']['status'] == 500" 
        color="primary" 
        class="nav-button next-button" 
        (click)="nextStep()" 
        *ngIf="currentStep == 2">
        {{ 'buttons.next' | translate }}
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        [disabled]="!this.results" 
        color="primary" 
        class="nav-button next-button" 
        (click)="nextStep()" 
        *ngIf="currentStep == 3">
        {{ 'buttons.next' | translate }}
        <ion-icon name="arrow-forward" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        [disabled]="!userName || userName == '' ||!userEmail || userEmail =='' || !sendPdf && !sendExcel || sendingForm || !userSession" 
        color="primary" 
        class="nav-button send-button" 
        (click)="sendResult()" 
        *ngIf="currentStep == 4">
        <ion-icon name="send" slot="start"></ion-icon>
        {{ 'buttons.send' | translate }}
      </ion-button>

      <ion-button 
        fill="outline" 
        color="medium" 
        class="nav-button exit-button" 
        (click)="closeProcess()" 
        *ngIf="currentStep == 5 && travelSelected['process_status'] == 2">
        <ion-icon name="close" slot="start"></ion-icon>
        {{ 'buttons.exit' | translate }}
      </ion-button>
      
    </div>
  </ion-toolbar>
</ion-footer>