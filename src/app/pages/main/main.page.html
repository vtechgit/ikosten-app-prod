<ion-header class="header-primary">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button color="light"></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ 'titles.modules.receipts.my-receipts' | translate }}</ion-title>
    <ion-buttons slot="end">

    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="receipts-container">
  <div class="receipts-content">
    
    <!-- Header Section -->
    <div class="header-section">
      <div class="header-content">
        <ion-icon name="receipt" class="header-icon"></ion-icon>
        <h1 class="header-title">{{ 'titles.modules.receipts.upload-title' | translate }}</h1>
        <p class="header-subtitle">{{ 'titles.modules.receipts.upload-subtitle' | translate }}</p>
      </div>
    </div>

    <!-- Country Chips Section -->
    <div class="selected-countries" *ngIf="userCountries && userCountries.length > 0">
      <p class="countries-label">{{ 'titles.modules.receipts.countries' | translate }}:</p>
      <div class="country-chips">
        <ion-chip
          *ngFor="let country of userCountries; index as iCountry"
          [color]="selectedCountryIndex == iCountry ? 'primary' : 'light'"
          (click)="selectCountry(iCountry)">
          <ion-icon name="flag"></ion-icon>
          <ion-label>{{country.country_translate_key | translate}}</ion-label>
        </ion-chip>
        
        <!-- Add Country Chip -->
        <ion-chip
          color="light"
          (click)="showModalPicker('inputs.select-country.title','add_country')">
          <ion-icon name="add-circle"></ion-icon>
          <ion-label>{{ 'buttons.add-country' | translate }}</ion-label>
        </ion-chip>
      </div>
    </div>

    <!-- Country Selector (first time) -->
    <div class="country-selector-section" *ngIf="!isLoadingReceipts && userCountries && userCountries.length === 0">
      <div class="selector-card">
        <h3 class="selector-title">{{ 'titles.modules.receipts.select-first-country' | translate }}</h3>
        <div class="country-selector" (click)="showModalPicker('inputs.select-country.title','country')">
          <div class="selector-content">
            <ion-icon name="flag-outline" class="selector-icon"></ion-icon>
            <div class="selector-text">
              <span class="selector-value" *ngIf="currencyBlockSelected">
                {{ currencyBlockSelected['country_translate_key'] | translate}} ({{currencyBlockSelected['code']}})
              </span>
              <span class="selector-placeholder" *ngIf="!currencyBlockSelected">
                {{ 'inputs.select-country.placeholder' | translate }}
              </span>
            </div>
            <ion-icon name="chevron-forward" class="selector-chevron"></ion-icon>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Receipts -->
    <div class="loading-section" *ngIf="isLoadingReceipts">
      <div class="loading-content">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p class="loading-text">{{ 'loadings.loading-receipts' | translate }}</p>
      </div>
    </div>

    <!-- Receipts Section -->
    <div class="receipts-section" *ngIf="currentCountryData && !isLoadingReceipts">
      
      <!-- Botón para eliminar todos los recibos -->
      <div class="section-actions" *ngIf="hasReceipts() && !isUploadingOther">
        <ion-button
          fill="clear"
          color="danger"
          size="small"
          (click)="deleteAllReceipts()">
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          {{ 'buttons.delete-all-receipts' | translate }}
        </ion-button>
      </div>

      <!-- Lista de archivos subiendo (siempre arriba cuando existen) -->
      <div class="uploading-files" *ngIf="uploadingFiles && uploadingFiles.length > 0">
        <div class="uploading-item" *ngFor="let file of uploadingFiles; index as i"
             [class.success]="file.status === 'success'"
             [class.error]="file.status === 'error'"
             [class.uploading]="file.status === 'uploading'">
          
          <div class="file-icon">
            <ion-icon 
              name="checkmark-circle" 
              color="success" 
              *ngIf="file.status === 'success'"></ion-icon>
            <ion-icon 
              name="close-circle" 
              color="danger" 
              *ngIf="file.status === 'error'"></ion-icon>
            <ion-spinner 
              name="crescent" 
              color="primary" 
              *ngIf="file.status === 'uploading'"></ion-spinner>
          </div>

          <div class="file-info">
            <p class="file-name">{{file.name}}</p>
            <p class="file-size">{{formatFileSize(file.size)}}</p>
            
            <!-- Progress bar individual -->
            <ion-progress-bar 
              *ngIf="file.status === 'uploading'" 
              type="indeterminate"
              color="primary"></ion-progress-bar>
            
            <!-- Mensaje de estado -->
            <p class="file-status success" *ngIf="file.status === 'success'">
              {{ 'loadings.upload-complete' | translate }}
            </p>
            <p class="file-status error" *ngIf="file.status === 'error'">
              {{ 'errors.file-uploads.try-again' | translate }}
            </p>
          </div>
        </div>
      </div>

      <!-- Lista de recibos subidos -->
      <div class="receipts-list" *ngIf="hasReceipts() && !isUploadingOther">
        <div class="receipt-item" *ngFor="let receipt of getCurrentReceipts(); index as i"
             [class.success]="receipt.analysis_status == 201 && receipt.document_result?.vendor"
             [class.error]="receipt.analysis_status == 500 || (receipt.analysis_status == 201 && !receipt.document_result?.vendor)"
             [class.loading]="receipt.analysis_status == 0">
          
          <div class="receipt-icon">
            <ion-icon
              name="checkmark-circle"
              color="success"
              *ngIf="receipt.analysis_status == 201 && receipt.document_result?.vendor"></ion-icon>
            <ion-icon
              name="warning"
              color="warning"
              *ngIf="receipt.analysis_status == 201 && !receipt.document_result?.vendor"></ion-icon>
            <ion-icon
              name="close-circle"
              color="danger"
              *ngIf="receipt.analysis_status == 500"></ion-icon>
            <ion-spinner
              name="crescent"
              *ngIf="receipt.analysis_status == 0"></ion-spinner>
          </div>

          <div class="receipt-info">
            <p class="receipt-vendor" *ngIf="receipt.analysis_status == 201 && receipt.document_result?.vendor">
              {{receipt.document_result.vendor}}
            </p>
            <p class="receipt-vendor error" *ngIf="receipt.analysis_status == 201 && !receipt.document_result?.vendor">
              {{ 'errors.file-uploads.cannot-read-vendor' | translate }}
            </p>
            <p class="receipt-vendor" *ngIf="receipt.analysis_status == 500">
              {{receipt.original_name}}
            </p>
            <p class="receipt-vendor" *ngIf="receipt.analysis_status == 0">
              {{ 'loadings.analysing' | translate }}...
            </p>

            <div class="receipt-details" *ngIf="receipt.analysis_status == 201 && receipt.document_result">
              <span class="detail-date" *ngIf="receipt.document_result.date">{{receipt.document_result.date | date: 'dd/MM/yyyy'}}</span>
              <span class="detail-amount" *ngIf="receipt.document_result.total">${{receipt.document_result.total | number}} {{getCurrentCurrency()}}</span>
            </div>
          </div>

          <ion-button
            fill="clear"
            color="danger"
            size="small"
            (click)="deleteReceipt(receipt._id)">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        
        <!-- Infinite Scroll -->
        <ion-infinite-scroll 
          threshold="200px" 
          (ionInfinite)="loadMoreReceipts($event)"
          [disabled]="!hasMoreReceipts">
          <ion-infinite-scroll-content
            loadingSpinner="crescent"
            loadingText="{{ 'loadings.loading-more-receipts' | translate }}">
          </ion-infinite-scroll-content>
        </ion-infinite-scroll>
      </div>

      <!-- Sección de subida de archivos -->
      <div class="upload-section" *ngIf="(!hasReceipts() || isUploadingOther) && !isUploading && uploadingFiles.length === 0">
        <!-- Subida de fotos (solo móvil) -->
        <div class="upload-option" *ngIf="(!imagesToUpload || imagesToUpload.length == 0)">
          <div class="upload-card" (click)="takePhoto()">
            <ion-icon name="camera" class="upload-icon"></ion-icon>
            <p class="upload-title">{{ 'titles.modules.process.step2.file-input.take-picture' | translate }}</p>
          </div>
        </div>

        <!-- Subida de archivos -->
        <div class="upload-option" *ngIf="(!imagesToUpload || imagesToUpload.length == 0)">
          <div class="upload-card" appDropFilesInput (fileDropped)="onFileDropped($event)">
            <input
              type="file"
              accept="image/jpeg,image/png,application/pdf"
              multiple="true"
              [disabled]="isUploading"
              #fileDrop
              id="fileDrop"
              (change)="fileBrowseHandler($event)">
            <ion-icon name="cloud-upload" class="upload-icon"></ion-icon>
            <p class="upload-title">{{ 'titles.modules.process.step2.file-input.upload-file' | translate }}</p>
          </div>
        </div>

        <!-- Preview de imágenes -->
        <div class="image-preview" *ngIf="imagesToUpload && imagesToUpload.length > 0">
          <div class="preview-item" *ngFor="let image of imagesToUpload; index as i">
            <ion-button
              fill="clear"
              color="danger"
              class="delete-preview"
              (click)="deleteImageToUpload(i)">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-img [src]="image.dataUrl"></ion-img>
          </div>
          <div class="preview-item add-more" (click)="takePhoto()">
            <ion-icon name="add"></ion-icon>
          </div>
        </div>

        <ion-button
          *ngIf="hasReceipts() || isAddingNewCountry"
          expand="block"
          fill="outline"
          color="primary"
          (click)="hasReceipts() ? isUploadingOther=false : cancelAddNewCountry()">
          {{ 'buttons.cancel' | translate }}
        </ion-button>
      </div>
    </div>



  </div>

  <!-- Modales -->
  <app-country-picker
    (optionSelected)="pickerOptionSelected($event)"
    (dismiss)="pickerDismissed()"
    [selectedOption]="currencyBlockSelected"
    [isModalOpen]="showPicker"
    [modalTitle]="pickerTitle"
    [type]="pickerType"
    [options]="pickerOptions"
    [temp]="pickerOptions">
  </app-country-picker>

  <!-- Alertas -->
  <ion-alert
    [isOpen]="isAlertDeleteReceipt"
    header="{{ 'alerts.delete-receipt.title' | translate }}"
    subHeader="{{ 'alerts.delete-receipt.subtitle' | translate }}"
    [buttons]="deleteReceiptAlertButtons"
    (didDismiss)="dismissDeleteReceipt()">
  </ion-alert>

  <ion-alert
    [isOpen]="isAlertDeleteAllReceipts"
    header="{{ 'alerts.delete-all-receipts.title' | translate }}"
    subHeader="{{ 'alerts.delete-all-receipts.subtitle' | translate }}"
    [buttons]="deleteAllReceiptsAlertButtons"
    (didDismiss)="dismissDeleteAllReceipts()">
  </ion-alert>

  <!-- Modal de Memberships (cuando se alcanza el límite) -->
  <app-membership-modal
    [isOpen]="showMembershipModal"
    [uploadLimitData]="uploadLimitData"
    (dismiss)="onMembershipModalDismiss()">
  </app-membership-modal>

</ion-content>

<!-- Footer con botón flotante -->
<ion-footer class="ion-no-border" *ngIf="hasReceipts() && !isUploadingOther">
  <ion-toolbar>
    <ion-button
      expand="block"
      color="primary"
      size="large"
      [disabled]="checkReceiptsErrors()"
      (click)="openUploading()">
      <ion-icon name="add-circle" slot="start"></ion-icon>
      {{ 'buttons.add-receipt' | translate }}
    </ion-button>
  </ion-toolbar>
</ion-footer>
