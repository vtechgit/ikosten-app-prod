<div class="register-container">
  <!-- Welcome Section -->
  <div class="welcome-section" *ngIf="!isLoginGoogle && !isLoginApple">
    <div class="back-button-container">
      <ion-button 
        fill="clear" 
        (click)="goBack()" 
        class="back-button">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        {{'buttons.back' | translate}}
      </ion-button>
    </div>
    <div class="welcome-content">
      <ion-img class="full-logo-img" src="../../../assets/images/ikosten_identificador_blanco_no_slogan.png"></ion-img>
      <h1 class="welcome-title">{{mainTitle | translate}}</h1>
      <p class="welcome-subtitle">{{'titles.modules.register.subtitle' | translate}}</p>
    </div>
  </div>

  <!-- Registration Form -->
  <div class="register-form-section" *ngIf="!isLoginGoogle && !isLoginApple">
    <div class="form-card">
      <form [formGroup]="registerForm" class="register-form">
        <div class="form-fields">
          <div class="input-group">
            <ion-item class="custom-input" [class.error]="(name.touched || name.dirty || submitted) && name.invalid">
              <ion-input 
                label="{{'inputs.user-name.title' | translate}}" 
                type="text" 
                labelPlacement="floating" 
                placeholder="{{'inputs.user-name.place-holder' | translate}}"
                name="registerName" 
                formControlName="registerName">
              </ion-input>
              <ion-icon name="person-outline" slot="start" class="input-icon"></ion-icon>
            </ion-item>
            <div class="error-message" *ngIf="(name.touched || name.dirty || submitted) && name.hasError('required')">
              {{'inputs.user-name.title' | translate}} {{'errors.inputs.is-required' | translate}}
            </div>
            <div class="error-message" *ngIf="(name.touched || name.dirty || submitted) && name.hasError('minlength')">
              {{'errors.validation.name.min-length' | translate}}
            </div>
            <div class="error-message" *ngIf="(name.touched || name.dirty || submitted) && name.hasError('maxlength')">
              {{'errors.validation.name.max-length' | translate}}
            </div>
          </div>

          <div class="input-group">
            <ion-item class="custom-input" [class.error]="(email.touched || email.dirty || submitted) && (email.hasError('required') || email.hasError('email'))">
              <ion-input 
                label="{{'inputs.email.title' | translate}}" 
                type="email" 
                labelPlacement="floating" 
                placeholder="{{'inputs.email.placeholder' | translate}}"
                name="registerEmail" 
                formControlName="registerEmail">
              </ion-input>
              <ion-icon name="mail-outline" slot="start" class="input-icon"></ion-icon>
            </ion-item>
            <div class="error-message" *ngIf="(email.touched || email.dirty || submitted) && (email.hasError('required') || email.hasError('email'))">
              {{'inputs.email.title' | translate}} {{'errors.inputs.invalid' | translate}}
            </div>
          </div>

          <div class="input-group">
            <ion-item class="custom-input" [class.error]="(countrySelect.touched || countrySelect.dirty || submitted) && countrySelect.hasError('required')">
              <ion-select 
                label="{{'global.words.country' | translate}}"
                name="registerCountry" 
                formControlName="registerCountry"
                labelPlacement="floating">
                <ion-select-option *ngFor="let country of availableCountries" [value]="country">
                  {{convertKey(country.title) | translate}}
                </ion-select-option>
              </ion-select>
              <ion-icon name="location-outline" slot="start" class="input-icon"></ion-icon>
            </ion-item>
            <div class="error-message" *ngIf="(countrySelect.touched || countrySelect.dirty || submitted) && countrySelect.hasError('required')">
              {{'global.words.country' | translate}} {{'errors.inputs.is-required' | translate}}
            </div>
          </div>

          <div class="input-group">
            <ion-item class="custom-input" [class.error]="(phone.touched || phone.dirty || submitted) && phone.hasError('required')">
              <ion-input 
                label="{{'inputs.phone-number.title' | translate}}" 
                type="tel" 
                labelPlacement="floating" 
                placeholder="{{'inputs.phone-number.placeholder' | translate}}"
                name="registerPhone" 
                formControlName="registerPhone">
              </ion-input>
              <ion-icon name="call-outline" slot="start" class="input-icon"></ion-icon>
            </ion-item>
            <div class="error-message" *ngIf="(phone.touched || phone.dirty || submitted) && phone.hasError('required')">
              {{'inputs.phone-number.title' | translate}} {{'errors.inputs.is-required' | translate}}
            </div>
          </div>

          <div class="input-group">
            <ion-item class="custom-input" [class.error]="(password.touched || password.dirty || submitted) && password.invalid">
              <ion-input 
                label="{{'inputs.password.title' | translate}}" 
                type="password" 
                labelPlacement="floating" 
                placeholder="{{'inputs.password.placeholder' | translate}}"
                name="registerPass" 
                formControlName="registerPass">
                <ion-input-password-toggle slot="end" *ngIf="password.value && password.value.length > 0"></ion-input-password-toggle>
              </ion-input>
              <ion-icon name="lock-closed-outline" slot="start" class="input-icon"></ion-icon>
            </ion-item>
            <div class="error-message" *ngIf="(password.touched || password.dirty || submitted) && password.hasError('required')">
              {{'inputs.password.title' | translate}} {{'errors.inputs.is-required.f' | translate}}
            </div>
            <div class="error-message" *ngIf="(password.touched || password.dirty || submitted) && password.hasError('minlength')">
              {{'errors.validation.password.min-length' | translate}}
            </div>
            <div class="error-message" *ngIf="(password.touched || password.dirty || submitted) && password.hasError('passwordStrength')">
              <div *ngIf="!password.errors.passwordStrength.hasUpperCase">{{'errors.validation.password.uppercase' | translate}}</div>
              <div *ngIf="!password.errors.passwordStrength.hasLowerCase">{{'errors.validation.password.lowercase' | translate}}</div>
              <div *ngIf="!password.errors.passwordStrength.hasNumber">{{'errors.validation.password.number' | translate}}</div>
              <div *ngIf="!password.errors.passwordStrength.validCharacters">{{'errors.validation.password.special-chars' | translate}}</div>
            </div>
          </div>
        </div>

        <ion-button 
          [disabled]="isLoading" 
          expand="block" 
          (click)="onSubmit()" 
          color="primary" 
          class="register-button">
          <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
          <span *ngIf="!isLoading">{{'buttons.finish' | translate}}</span>
          <ion-icon *ngIf="!isLoading" name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>

        <!-- Social Login Section -->
        <div class="divider">
          <span class="divider-text">{{'titles.modules.login.or' | translate}}</span>
        </div>

        <div class="social-buttons">
          <ion-button 
            (click)="startLoginGoogle()" 
            [disabled]="!countriesLoaded"
            expand="block" 
            fill="outline" 
            class="social-button google-button">
            <ion-spinner name="crescent" *ngIf="!countriesLoaded" slot="start"></ion-spinner>
            <div class="social-icon" *ngIf="countriesLoaded">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                <path fill="none" d="M0 0h48v48H0z"></path>
              </svg>
            </div>
            {{'buttons.sing-in-with-google' | translate}}
          </ion-button>

          <ion-button 
            *ngIf="platform.is('ios') && !platform.is('mobileweb')" 
            (click)="startLoginApple()"
            [disabled]="!countriesLoaded" 
            expand="block" 
            fill="outline" 
            class="social-button apple-button">
            <ion-spinner name="crescent" *ngIf="!countriesLoaded" slot="start"></ion-spinner>
            <div class="social-icon" *ngIf="countriesLoaded">
              <img src="assets/images/apple_black_2x.png" alt="Apple">
            </div>
            {{'buttons.sing-in-with-apple' | translate}}
          </ion-button>
        </div>

        <div class="login-section">
          <ion-button 
            expand="block" 
            routerLink="/auth/login" 
            routerDirection="back" 
            fill="clear" 
            class="login-link-button">
            {{'buttons.login-register-button' | translate}}
          </ion-button>
        </div>
      </form>
    </div>
  </div>

  <!-- Google/Apple Country Selection -->
  <div class="country-selection" *ngIf="isLoginGoogle || isLoginApple">
    <div class="selection-card">
      <div class="back-button-container">
        <ion-button 
          fill="clear" 
          (click)="goBackToRegister()" 
          class="back-button">
          <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
          {{'buttons.back' | translate}}
        </ion-button>
      </div>
      <h2 class="selection-title">{{'titles.modules.login.google.title' | translate}}</h2>
      
      <div class="country-input">
        <ion-item class="custom-input">
          <ion-select 
            label="{{'global.words.country' | translate}}" 
            [(ngModel)]="selectedCountry" 
            labelPlacement="floating">
            <ion-select-option *ngFor="let country of availableCountries" [value]="country">
              {{convertKey(country.title) | translate}}
            </ion-select-option>
          </ion-select>
          <ion-icon name="location-outline" slot="start" class="input-icon"></ion-icon>
        </ion-item>
      </div>

      <div class="phone-input">
        <ion-item class="custom-input">
          <ion-input 
            label="{{'inputs.phone-number.title' | translate}}" 
            type="tel" 
            [(ngModel)]="userPhone" 
            labelPlacement="floating" 
            placeholder="{{'inputs.phone-number.placeholder' | translate}}">
          </ion-input>
          <ion-icon name="call-outline" slot="start" class="input-icon"></ion-icon>
        </ion-item>
        <div class="input-hint" *ngIf="selectedCountry">
          <ion-text color="medium">
            <small>{{'inputs.phone-number.hint' | translate}}: {{selectedCountry.digit}}</small>
          </ion-text>
        </div>
      </div>

      <ion-button 
        *ngIf="isLoginGoogle"
        [disabled]="isLoading || !selectedCountry || !userPhone" 
        expand="block" 
        (click)="loginGooglev2()" 
        color="primary" 
        class="continue-button">
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        <span *ngIf="!isLoading">{{'buttons.next' | translate}}</span>
        <ion-icon *ngIf="!isLoading" name="arrow-forward-outline" slot="end"></ion-icon>
      </ion-button>

      <ion-button 
        *ngIf="isLoginApple" 
        [disabled]="isLoading || !selectedCountry || !userPhone" 
        expand="block" 
        (click)="loginApplev2()" 
        color="primary" 
        class="continue-button">
        <ion-spinner name="crescent" *ngIf="isLoading"></ion-spinner>
        <span *ngIf="!isLoading">{{'buttons.next' | translate}}</span>
        <ion-icon *ngIf="!isLoading" name="arrow-forward-outline" slot="end"></ion-icon>
      </ion-button>
    </div>
  </div>
</div>

<ion-alert
  header="{{'alerts.general.header' | translate}}"
  subHeader="{{'alerts.general.try-again-later' | translate}}"
  [buttons]="alertButtons"
  [isOpen]="showAlertCodeError"
  (didDismiss)="showAlertCodeError=false"
  
></ion-alert>

<ion-alert
  header="{{'alerts.register.error.user-already-exist.title' | translate}}"
  subHeader="{{'alerts.register.error.user-already-exist.subtitle' | translate}}"
  [buttons]="alertButtons"
  [isOpen]="showAlertAlreadyExist"
  (didDismiss)="showAlertAlreadyExist=false"
  
></ion-alert>

<ion-alert
  header="{{'alerts.general.header' | translate}}"
  subHeader="{{'alerts.general.try-again-later' | translate}}"
  [buttons]="alertButtons"
  [isOpen]="showAppleAlertLogin"
  (didDismiss)="showAppleAlertLogin=false">
</ion-alert>

<!-- Loading Overlay for Social Login -->
<div class="loading-overlay" *ngIf="isLoading && (isLoginGoogle || isLoginApple)">
  <div class="loading-content">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p class="loading-message">{{ loadingMessage | translate }}</p>
  </div>
</div>
